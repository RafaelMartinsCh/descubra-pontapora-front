<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cadastro de Eventos</title>
  <link href="../src/icon.png" rel="icon" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
</head>

<body class="bg-light">
  <div id="header"></div>

  <!-- Alerta para mensagens de sucesso/erro -->
  <div id="alertaLogin" class="container mt-3"></div>

  <div class="container mt-4">
    <h2 class="mb-4">Cadastro de Eventos</h2>

    <!-- Formulário de Cadastro -->
    <div class="card mb-4">
      <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#collapseCadastro"
        aria-expanded="true" aria-controls="collapseCadastro">
        <h6 class="mb-0">Cadastrar Novo Evento</h6>
      </div>
      <div id="collapseCadastro" class="collapse show">
        <div class="card-body">
          <form id="formCadastro">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="titulo" class="form-label">Título</label>
                <input type="text" class="form-control" id="titulo" required>
              </div>
              <div class="col-md-6">
                <label for="local" class="form-label">Local</label>
                <input type="text" class="form-control" id="local" required>
              </div>
              <div class="col-md-4">
                <label for="data" class="form-label">Data</label>
                <input type="datetime-local" class="form-control" id="data" required>
              </div>
              <div class="col-md-4">
                <label for="dt_fim" class="form-label">Data Fim (opcional)</label>
                <input type="datetime-local" class="form-control" id="dt_fim">
              </div>
              <div class="col-md-4">
                <label for="descricao" class="form-label">Descrição</label>
                <input type="text" class="form-control" id="descricao" required>
              </div>
              <div class="col-md-6">
                <label for="imagem" class="form-label">URL Imagem Capa</label>
                <input type="url" class="form-control" id="imagem">
              </div>
              <div class="col-md-6">
                <label for="legenda_imagem" class="form-label">Legenda da Imagem</label>
                <input type="text" class="form-control" id="legenda_imagem">
              </div>
              <div class="col-12">
                <button type="submit" class="btn btn-primary w-100">Cadastrar</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Tabela de Eventos -->
    <div class="card">
      <div class="card-header fw-semibold">Eventos Cadastrados</div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered table-hover">
            <thead class="table-dark text-center">
              <tr>
                <th>Título</th>
                <th>Local</th>
                <th>Data</th>
                <th>Descrição</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tabelaEventos"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Editar Evento -->
  <div class="modal fade" id="modalEditarEvento" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Editar Evento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editId">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="editTitulo" class="form-label">Título</label>
              <input type="text" class="form-control" id="editTitulo" required>
            </div>
            <div class="col-md-6">
              <label for="editLocal" class="form-label">Local</label>
              <input type="text" class="form-control" id="editLocal" required>
            </div>
            <div class="col-md-4">
              <label for="editData" class="form-label">Data</label>
              <input type="datetime-local" class="form-control" id="editData" required>
            </div>
            <div class="col-md-4">
              <label for="editDtFim" class="form-label">Data Fim (opcional)</label>
              <input type="datetime-local" class="form-control" id="editDtFim">
            </div>

            <!-- Campo de descrição modificado para textarea -->
            <div class="col-md-6">
              <label for="editImagem" class="form-label">URL Imagem Capa</label>
              <input type="url" class="form-control" id="editImagem">
            </div>
            <div class="col-md-6">
              <label for="editLegendaImagem" class="form-label">Legenda da Imagem</label>
              <input type="text" class="form-control" id="editLegendaImagem">
            </div>

            <div class="col-12">
              <label for="editDescricao" class="form-label">Descrição</label>
              <textarea class="form-control" id="editDescricao" rows="3" required></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="atualizarEvento()">Salvar Alterações</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="../js/header_adm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../js/config.js"></script>
  <script src="../js/utils.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
    // DOM Elements
    const elements = {
        formCadastro: document.getElementById('formCadastro'),
        tabelaEventos: document.getElementById('tabelaEventos'),
        modalEditar: document.getElementById('modalEditarEvento'),
        btnSalvarEdicao: document.querySelector('#modalEditarEvento .btn-primary')
    };

    // Event Listeners
    elements.formCadastro.addEventListener('submit', enviar);
    elements.tabelaEventos.addEventListener('click', handleTableActions);
    elements.modalEditar.addEventListener('show.bs.modal', handleModalShow);
    elements.btnSalvarEdicao.addEventListener('click', atualizarEvento);

    // Initialize
    carregarEventos();

    // ========================
    //  Core Functions
    // ========================
    async function carregarEventos() {
        try {
            const response = await fetch(`${API_BASE_URL}/eventos/`);
            const eventos = await response.json();
            renderizarEventos(eventos);
        } catch (error) {
            mostraAlerta('Erro ao carregar eventos', 'danger');
        }
    }

    function renderizarEventos(eventos) {
        elements.tabelaEventos.innerHTML = eventos.map(evento => `
            <tr data-id="${evento.id}">
                <td>${evento.titulo}</td>
                <td>${evento.local}</td>
                <td>${new Date(evento.data).toLocaleString()}</td>
                <td>${evento.descricao}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-warning btn-editar me-2"
                        data-bs-toggle="modal"
                        data-bs-target="#modalEditarEvento"
                        data-event='${JSON.stringify(evento)}'>
                        Alterar
                    </button>
                    <button class="btn btn-sm btn-danger btn-excluir">Excluir</button>
                </td>
            </tr>
        `).join('');
    }

    // ========================
    //  Event Handlers
    // ========================
    async function enviar(e) {
        e.preventDefault();
        const formData = carregarDadosFormulario(elements.formCadastro);

        try {
            const response = await fetch(`${API_BASE_URL}/eventos/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                elements.formCadastro.reset();
                mostraAlerta('Evento cadastrado com sucesso!', 'success');
                await carregarEventos();
            } else {
                mostraAlerta('Erro ao cadastrar evento', 'danger');
            }
        } catch (error) {
            mostraAlerta('Erro na comunicação com o servidor', 'danger');
        }
    }

    function handleTableActions(e) {
        const target = e.target;
        const row = target.closest('tr');
        const eventId = row.dataset.id;

        if (target.classList.contains('btn-excluir')) {
            excluirEvento(eventId);
        }
    }

    function handleModalShow(e) {
        const button = e.relatedTarget;
        const eventData = JSON.parse(button.dataset.event);
        popularFormulario(eventData);
    }

    // ========================
    //  CRUD Operations
    // ========================
    async function atualizarEvento() {
        const eventId = document.getElementById('editId').value;
        const formData = carregarDadosEditadosDoFormulario();

        try {
            const response = await fetch(`${API_BASE_URL}/eventos/${eventId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                bootstrap.Modal.getInstance(elements.modalEditar).hide();
                mostraAlerta('Evento atualizado com sucesso!', 'success');
                await carregarEventos();
            } else {
                mostraAlerta('Erro ao atualizar evento', 'danger');
            }
        } catch (error) {
            mostraAlerta('Erro na comunicação com o servidor', 'danger');
        }
    }

    async function excluirEvento(eventId) {
        if (!confirm('Deseja realmente excluir este evento?')) return;

        try {
            const response = await fetch(`${API_BASE_URL}/eventos/${eventId}`, {
                method: 'DELETE'
            });

            if (response.status === 204) {
                mostraAlerta('Evento excluído com sucesso!', 'success');
                await carregarEventos();
            } else {
                mostraAlerta('Erro ao excluir evento', 'danger');
            }
        } catch (error) {
            mostraAlerta('Erro na comunicação com o servidor', 'danger');
        }
    }

    // ========================
    //  Helper Functions
    // ========================
    function carregarDadosFormulario(form) {
        return {
            titulo: form.querySelector('#titulo').value,
            local: form.querySelector('#local').value,
            data: form.querySelector('#data').value,
            dt_fim: form.querySelector('#dt_fim').value || null,
            descricao: form.querySelector('#descricao').value,
            caminho_imagem_capa: form.querySelector('#imagem').value || null,
            legenda_imagem_capa: form.querySelector('#legenda_imagem').value || null
        };
    }

    function carregarDadosEditadosDoFormulario() {
        return {
            titulo: document.getElementById('editTitulo').value,
            local: document.getElementById('editLocal').value,
            data: document.getElementById('editData').value,
            dt_fim: document.getElementById('editDtFim').value || null,
            descricao: document.getElementById('editDescricao').value,
            caminho_imagem_capa: document.getElementById('editImagem').value || null,
            legenda_imagem_capa: document.getElementById('editLegendaImagem').value || null
        };
    }

    function popularFormulario(eventData) {
        document.getElementById('editId').value = eventData.id;
        document.getElementById('editTitulo').value = eventData.titulo;
        document.getElementById('editLocal').value = eventData.local;
        document.getElementById('editData').value = formatarHoraLocal(eventData.data);
        document.getElementById('editDtFim').value = formatarHoraLocal(eventData.dt_fim);
        document.getElementById('editDescricao').value = eventData.descricao;
        document.getElementById('editImagem').value = eventData.caminho_imagem_capa || '';
        document.getElementById('editLegendaImagem').value = eventData.legenda_imagem_capa || '';
    }

    function formatarHoraLocal(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toISOString().slice(0, 16);
    }

    function mostraAlerta(message, type) {
        const alertDiv = document.getElementById('alertaLogin');
        alertDiv.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }
});
  </script>
</body>

</html>
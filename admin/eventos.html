<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cadastro de Eventos</title>
  <link href="../src/icon.png" rel="icon" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    /* Estilos para mensagens de erro */
    .invalid-feedback {
      display: none;
      margin-top: 0.25rem;
    }

    .is-invalid {
      border-color: #dc3545;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right calc(0.375em + 0.1875rem) center;
      background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
      padding-right: calc(1.5em + 0.75rem);
    }

    .was-validated .form-control:invalid,
    .form-control.is-invalid {
      border-color: #dc3545;
    }

    .was-validated .form-control:invalid:focus,
    .form-control.is-invalid:focus {
      border-color: #dc3545;
      box-shadow: 0 0 0 0.25rem rgba(220, 53, 69, 0.25);
    }

    /* Estilo para o botão de cadastro quando desabilitado */
    .btn-primary:disabled {
      opacity: 0.65;
      cursor: not-allowed;
    }

    /* Correção para modal visível */
    .modal.fade.show {
      display: block;
    }
  </style>
</head>

<body class="bg-light">
  <div vw="1" class="enabled">
  <div vw-access-button="true" class="active"></div>
  <div vw-plugin-wrapper="true">
    <div class="vw-plugin-top-wrapper"></div>
  </div>
</div>
<script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
<script>
  new window.VLibras.Widget('https://vlibras.gov.br/app');
</script>
  <div id="header"></div>

  <!-- Alerta para mensagens de sucesso/erro -->
  <div id="alertaLogin" class="container mt-3"></div>

  <div class="container mt-4">
    <h2 class="mb-4">Cadastro de Eventos</h2>

    <!-- Formulário de Cadastro -->
    <div class="card mb-4">
      <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#collapseCadastro"
        aria-expanded="true" aria-controls="collapseCadastro">
        <h6 class="mb-0">Cadastrar Novo Evento</h6>
      </div>
      <div id="collapseCadastro" class="collapse show">
        <div class="card-body">
          <form id="formCadastro" novalidate>
            <div class="row g-3">
              <div class="col-md-6">
                <label for="titulo" class="form-label">Título</label>
                <input type="text" class="form-control" id="titulo" required minlength="3" maxlength="100">
              </div>
              <div class="col-md-6">
                <label for="local" class="form-label">Local</label>
                <input type="text" class="form-control" id="local" required minlength="3" maxlength="100">
              </div>
              <div class="col-md-4">
                <label for="data" class="form-label">Data</label>
                <input type="datetime-local" class="form-control" id="data" required>
              </div>
              <div class="col-md-4">
                <label for="dt_fim" class="form-label">Data Fim (opcional)</label>
                <input type="datetime-local" class="form-control" id="dt_fim">
              </div>
              <div class="col-md-4">
                <label for="descricao" class="form-label">Descrição</label>
                <input type="text" class="form-control" id="descricao" required minlength="10" maxlength="255">
              </div>
              <div class="col-md-6">
                <label for="imagem" class="form-label">URL Imagem Capa</label>
                <input type="url" class="form-control" id="imagem" placeholder="https://exemplo.com/imagem.jpg">
              </div>
              <div class="col-md-6">
                <label for="legenda_imagem" class="form-label">Legenda da Imagem</label>
                <input type="text" class="form-control" id="legenda_imagem" maxlength="100">
              </div>
              <div class="col-md-6">
                <label for="site" class="form-label">Site do Evento</label>
                <input type="url" class="form-control" id="site" placeholder="https://siteevento.com">
              </div>

              <div class="col-md-6">
                <label for="aberto" class="form-label">Evento Aberto?</label>
                <select class="form-select" id="aberto" required>
                  <option value="">Selecione</option>
                  <option value="1">Sim</option>
                  <option value="0">Não</option>
                </select>
              </div>
              <div class="col-12">
                <button type="submit" class="btn btn-primary w-100">Cadastrar</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Tabela de Eventos -->
    <div class="card">
      <div class="card-header fw-semibold">Eventos Cadastrados</div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered table-hover">
            <thead class="table-dark text-center">
              <tr>
                <th>Título</th>
                <th>Local</th>
                <th>Data</th>
                <th>Descrição</th>
                <th>Aberto</th>
                <th>Site</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tabelaEventos">
              <!-- Os eventos serão carregados dinamicamente -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Editar Evento -->
  <div class="modal fade" id="modalEditarEvento" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Editar Evento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editId">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="editTitulo" class="form-label">Título</label>
              <input type="text" class="form-control" id="editTitulo" required minlength="3" maxlength="100">
              <div class="invalid-feedback">O título deve ter entre 3 e 100 caracteres.</div>
            </div>
            <div class="col-md-6">
              <label for="editLocal" class="form-label">Local</label>
              <input type="text" class="form-control" id="editLocal" required minlength="3" maxlength="100">
              <div class="invalid-feedback">O local deve ter entre 3 e 100 caracteres.</div>
            </div>
            <div class="col-md-4">
              <label for="editData" class="form-label">Data</label>
              <input type="datetime-local" class="form-control" id="editData" required>
              <div class="invalid-feedback">Por favor, informe uma data válida.</div>
            </div>
            <div class="col-md-4">
              <label for="editDtFim" class="form-label">Data Fim (opcional)</label>
              <input type="datetime-local" class="form-control" id="editDtFim">
              <div class="invalid-feedback">A data final deve ser posterior à data inicial.</div>
            </div>
            <div class="col-md-6">
              <label for="editImagem" class="form-label">URL Imagem Capa</label>
              <input type="url" class="form-control" id="editImagem" placeholder="https://exemplo.com/imagem.jpg">
              <div class="invalid-feedback">Por favor, insira uma URL válida.</div>
            </div>
            <div class="col-md-6">
              <label for="editLegendaImagem" class="form-label">Legenda da Imagem</label>
              <input type="text" class="form-control" id="editLegendaImagem" maxlength="100">
              <div class="invalid-feedback">A legenda não pode ter mais de 100 caracteres.</div>
            </div>
            <div class="col-md-6">
              <label for="editSite" class="form-label">Site do Evento</label>
              <input type="url" class="form-control" id="editSite" placeholder="https://siteevento.com">
              <div class="invalid-feedback">Por favor, insira uma URL válida.</div>
            </div>

            <div class="col-md-6">
              <label for="editAberto" class="form-label">Evento Aberto?</label>
              <select class="form-select" id="editAberto" required>
                <option value="">Selecione</option>
                <option value="1">Sim</option>
                <option value="0">Não</option>
              </select>
              <div class="invalid-feedback">Selecione se o evento é aberto.</div>
            </div>
            <div class="col-12">
              <label for="editDescricao" class="form-label">Descrição</label>
              <textarea class="form-control" id="editDescricao" rows="3" required minlength="10"
                maxlength="255"></textarea>
              <div class="invalid-feedback">A descrição deve ter entre 10 e 255 caracteres.</div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <!-- CORREÇÃO: Removido o onclick e adicionado id para o botão -->
          <button class="btn btn-primary" id="btnSalvarEdicao">Salvar Alterações</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="../js/header_adm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../js/config.js"></script>
  <script src="../js/utils.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // DOM Elements
    const elements = {
      formCadastro: document.getElementById('formCadastro'),
      tabelaEventos: document.getElementById('tabelaEventos'),
      modalEditar: document.getElementById('modalEditarEvento'),
      btnSalvarEdicao: document.getElementById('btnSalvarEdicao')
    };

    // Event Listeners
    elements.formCadastro.addEventListener('submit', enviar);
    elements.tabelaEventos.addEventListener('click', handleTableActions);
    elements.modalEditar.addEventListener('show.bs.modal', handleModalShow);
    elements.btnSalvarEdicao.addEventListener('click', atualizarEvento);

    // Adicionar event listeners para validação em tempo real
    setupEventListenersForValidation();

    // Initialize
    carregarEventos();

    function setupEventListenersForValidation() {
      // Campos do formulário de cadastro
      const camposCadastro = [
        { id: 'titulo', min: 3, max: 100 },
        { id: 'local', min: 3, max: 100 },
        { id: 'data', tipo: 'data', required: true },
        { id: 'dt_fim', tipo: 'data', opcional: true },
        { id: 'descricao', min: 10, max: 255 },
        { id: 'imagem', tipo: 'url', opcional: true },
        { id: 'legenda_imagem', max: 100, opcional: true }
      ];

      camposCadastro.forEach(campo => {
        const element = document.getElementById(campo.id);
        if (element) {
          element.addEventListener('input', () => validarCampo(element, campo));
          element.addEventListener('blur', () => validarCampo(element, campo));
        }
      });

      // Campos do formulário de edição
      const camposEdicao = [
        { id: 'editTitulo', min: 3, max: 100 },
        { id: 'editLocal', min: 3, max: 100 },
        { id: 'editData', tipo: 'data', required: true },
        { id: 'editDtFim', tipo: 'data', opcional: true },
        { id: 'editDescricao', min: 10, max: 255 },
        { id: 'editImagem', tipo: 'url', opcional: true },
        { id: 'editLegendaImagem', max: 100, opcional: true }
      ];

      camposEdicao.forEach(campo => {
        const element = document.getElementById(campo.id);
        if (element) {
          element.addEventListener('input', () => validarCampo(element, campo));
          element.addEventListener('blur', () => validarCampo(element, campo));
        }
      });

      // Validação de datas relacionadas
      document.getElementById('data').addEventListener('change', () => {
        validarDatasRelacionadas('data', 'dt_fim');
      });
      document.getElementById('dt_fim').addEventListener('change', () => {
        validarDatasRelacionadas('data', 'dt_fim');
      });
      document.getElementById('editData').addEventListener('change', () => {
        validarDatasRelacionadas('editData', 'editDtFim');
      });
      document.getElementById('editDtFim').addEventListener('change', () => {
        validarDatasRelacionadas('editData', 'editDtFim');
      });
    }

    function validarCampo(campo, config) {
      // Não remover erros automaticamente - apenas na validação específica
      if (config.required && !campo.value) {
        mostrarErro(campo, 'Este campo é obrigatório.');
        return false;
      }

      // Validar comprimento mínimo
      if (config.min && campo.value.trim().length < config.min) {
        mostrarErro(campo, `Este campo deve ter pelo menos ${config.min} caracteres.`);
        return false;
      }

      // Validar comprimento máximo
      if (config.max && campo.value.trim().length > config.max) {
        mostrarErro(campo, `Este campo não pode ter mais de ${config.max} caracteres.`);
        return false;
      }

      // Validar URL
      if (config.tipo === 'url' && campo.value.trim() && !isValidUrl(campo.value)) {
        mostrarErro(campo, 'Por favor, insira uma URL válida.');
        return false;
      }

      if (config.tipo === 'select' && config.required) {
        if (campo.value === '') {
          mostrarErro(campo, 'Este campo é obrigatório.');
          return false;
        }
      }

      // Validação específica para campo de data
      if (config.tipo === 'data' && campo.value) {
        const data = new Date(campo.value);
        if (isNaN(data.getTime())) {
          mostrarErro(campo, 'Por favor, informe uma data válida.');
          return false;
        }
      }

      // Se passou em todas as validações, remover erros
      removerErro(campo);
      return true;
    }

    function validarDatasRelacionadas(idDataInicio, idDataFim) {
      const dataInicio = document.getElementById(idDataInicio);
      const dataFim = document.getElementById(idDataFim);

      if (!dataInicio.value) return true;

      const inicio = new Date(dataInicio.value);
      const fim = dataFim.value ? new Date(dataFim.value) : null;

      if (fim && fim <= inicio) {
        mostrarErro(dataFim, 'A data final deve ser posterior à data inicial.');
        return false;
      }

      // Remover erro apenas da validação de datas relacionadas
      if (dataFim.nextElementSibling?.textContent === 'A data final deve ser posterior à data inicial.') {
        removerErro(dataFim);
      }

      return true;
    }

    function isValidUrl(string) {
      try {
        new URL(string);
        return true;
      } catch (_) {
        return false;
      }
    }

    function mostrarErro(campo, mensagem) {
      // Criar elemento de erro se não existir
      let feedback = campo.nextElementSibling;
      if (!feedback || !feedback.classList.contains('invalid-feedback')) {
        feedback = document.createElement('div');
        feedback.className = 'invalid-feedback';
        campo.parentNode.appendChild(feedback);
      }

      feedback.textContent = mensagem;
      campo.classList.add('is-invalid');
    }

    function removerErro(campo) {
      campo.classList.remove('is-invalid');
      const feedback = campo.nextElementSibling;
      if (feedback && feedback.classList.contains('invalid-feedback')) {
        feedback.textContent = '';
      }
    }

    function validarFormulario(formId) {
      let valido = true;
      let campos = [];

      // Obter a lista de campos conforme o formulário
      if (formId === 'formCadastro') {
        campos = [
          { id: 'titulo', min: 3, max: 100 },
          { id: 'local', min: 3, max: 100 },
          { id: 'data', tipo: 'data', required: true },
          { id: 'dt_fim', tipo: 'data', opcional: true },
          { id: 'descricao', min: 10, max: 255 },
          { id: 'imagem', tipo: 'url', opcional: true },
          { id: 'legenda_imagem', max: 100, opcional: true },
          { id: 'site', tipo: 'url', opcional: true },
          { id: 'aberto', tipo: 'select', required: true }
        ];
      } else if (formId === 'formEdicao') {
        campos = [
          { id: 'editTitulo', min: 3, max: 100 },
          { id: 'editLocal', min: 3, max: 100 },
          { id: 'editData', tipo: 'data', required: true },
          { id: 'editDtFim', tipo: 'data', opcional: true },
          { id: 'editDescricao', min: 10, max: 255 },
          { id: 'editImagem', tipo: 'url', opcional: true },
          { id: 'editLegendaImagem', max: 100, opcional: true },
          { id: 'editSite', tipo: 'url', opcional: true },
          { id: 'editAberto', tipo: 'select', required: true }
        ];
      }

      // Validar cada campo
      campos.forEach(campo => {
        const element = document.getElementById(campo.id);
        if (element) {
          if (!validarCampo(element, campo)) {
            valido = false;
          }
        }
      });

      // Validações adicionais (datas relacionadas)
      if (formId === 'formCadastro') {
        if (!validarDatasRelacionadas('data', 'dt_fim')) {
          valido = false;
        }
      } else if (formId === 'formEdicao') {
        if (!validarDatasRelacionadas('editData', 'editDtFim')) {
          valido = false;
        }
      }

      return valido;
    }

    async function carregarEventos() {
      try {
        const response = await fetch(`${API_BASE_URL}/eventos/`);
        if (!response.ok) {
          throw new Error('Falha ao carregar eventos');
        }
        const eventos = await response.json();
        renderizarEventos(eventos);
      } catch (error) {
        mostraAlerta('Erro ao carregar eventos: ' + error.message, 'danger');
      }
    }

    function renderizarEventos(eventos) {
      elements.tabelaEventos.innerHTML = eventos.map(evento => `
        <tr data-id="${evento.id}">
          <td>${evento.titulo}</td>
          <td>${evento.local}</td>
          <td>${
            new Date(evento.data).getUTCDate().toString().padStart(2,'0') + '/' +
            (new Date(evento.data).getUTCMonth()+1).toString().padStart(2,'0') + '/' +
            new Date(evento.data).getUTCFullYear() + ' ' +
            new Date(evento.data).getUTCHours().toString().padStart(2,'0') + ':' +
            new Date(evento.data).getUTCMinutes().toString().padStart(2,'0')
          }</td>
          <td>${evento.descricao}</td>
          <td>${evento.aberto ? 'Sim' : 'Não'}</td>
          <td>${evento.site ? `<a href="${evento.site}" target="_blank">Link</a>` : '-'}</td>
          <td class="text-center">
            <button class="btn btn-sm btn-warning btn-editar me-2"
                data-bs-toggle="modal"
                data-bs-target="#modalEditarEvento"
                data-event='${JSON.stringify(evento)}'>
                Alterar
            </button>
            <button class="btn btn-sm btn-danger btn-excluir">Excluir</button>
          </td>
        </tr>
      `).join('');
    }

    async function enviar(e) {
      e.preventDefault();

      // Validar formulário
      if (!validarFormulario('formCadastro')) {
        return;
      }

      const formData = carregarDadosFormulario(elements.formCadastro);

      try {
        const response = await fetch(`${API_BASE_URL}/eventos/`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        if (response.ok) {
          elements.formCadastro.reset();
          mostraAlerta('Evento cadastrado com sucesso!', 'success');
          await carregarEventos();
        } else {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Erro desconhecido');
        }
      } catch (error) {
        mostraAlerta('Erro ao cadastrar evento: ' + error.message, 'danger');
      }
    }

    function handleTableActions(e) {
      const target = e.target;
      const row = target.closest('tr');
      
      if (!row) return;
      
      const eventId = row.dataset.id;

      if (target.classList.contains('btn-excluir')) {
        excluirEvento(eventId);
      }
    }

    function handleModalShow(e) {
      const button = e.relatedTarget;
      if (!button) return;
      
      try {
        const eventData = JSON.parse(button.dataset.event);
        popularFormulario(eventData);
      } catch (error) {
        console.error('Erro ao analisar dados do evento:', error);
      }
    }

    async function atualizarEvento() {
      // Validar formulário de edição
      if (!validarFormulario('formEdicao')) {
        return;
      }

      const eventId = document.getElementById('editId').value;
      const formData = carregarDadosEditadosDoFormulario();

      try {
        const response = await fetch(`${API_BASE_URL}/eventos/${eventId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        if (response.ok) {
          // Fechar modal de forma programática
          const modal = bootstrap.Modal.getInstance(elements.modalEditar);
          if (modal) modal.hide();
          
          mostraAlerta('Evento atualizado com sucesso!', 'success');
          await carregarEventos();
        } else {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Erro desconhecido');
        }
      } catch (error) {
        mostraAlerta('Erro ao atualizar evento: ' + error.message, 'danger');
      }
    }

    async function excluirEvento(eventId) {
      if (!eventId || !confirm('Deseja realmente excluir este evento?')) return;

      try {
        const response = await fetch(`${API_BASE_URL}/eventos/${eventId}`, {
          method: 'DELETE'
        });

        if (response.status === 204) {
          mostraAlerta('Evento excluído com sucesso!', 'success');
          await carregarEventos();
        } else {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Erro desconhecido');
        }
      } catch (error) {
        mostraAlerta('Erro ao excluir evento: ' + error.message, 'danger');
      }
    }

    function carregarDadosFormulario(form) {
      return {
        titulo: form.querySelector('#titulo').value,
        local: form.querySelector('#local').value,
        data: form.querySelector('#data').value,
        dt_fim: form.querySelector('#dt_fim').value || null,
        descricao: form.querySelector('#descricao').value,
        caminho_imagem_capa: form.querySelector('#imagem').value || null,
        legenda_imagem_capa: form.querySelector('#legenda_imagem').value || null,
        site: form.querySelector('#site').value || null,
        aberto: parseInt(form.querySelector('#aberto').value)
      };
    }

    function carregarDadosEditadosDoFormulario() {
      return {
        titulo: document.getElementById('editTitulo').value,
        local: document.getElementById('editLocal').value,
        data: document.getElementById('editData').value,
        dt_fim: document.getElementById('editDtFim').value || null,
        descricao: document.getElementById('editDescricao').value,
        caminho_imagem_capa: document.getElementById('editImagem').value || null,
        legenda_imagem_capa: document.getElementById('editLegendaImagem').value || null,
        site: document.getElementById('editSite').value || null,
        aberto: parseInt(document.getElementById('editAberto').value)
      };
    }

    function popularFormulario(eventData) {
      if (!eventData) return;
      
      document.getElementById('editId').value = eventData.id;
      document.getElementById('editTitulo').value = eventData.titulo || '';
      document.getElementById('editLocal').value = eventData.local || '';
      document.getElementById('editData').value = formatarHoraLocal(eventData.data);
      document.getElementById('editDtFim').value = formatarHoraLocal(eventData.dt_fim);
      document.getElementById('editDescricao').value = eventData.descricao || '';
      document.getElementById('editImagem').value = eventData.caminho_imagem_capa || '';
      document.getElementById('editLegendaImagem').value = eventData.legenda_imagem_capa || '';
      document.getElementById('editSite').value = eventData.site || '';
      document.getElementById('editAberto').value = eventData.aberto != null ? String(eventData.aberto) : '';
    }

    function formatarHoraLocal(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return '';
      const year = date.getUTCFullYear();
      const month = String(date.getUTCMonth() + 1).padStart(2, '0');
      const day = String(date.getUTCDate()).padStart(2, '0');
      const hours = String(date.getUTCHours()).padStart(2, '0');
      const minutes = String(date.getUTCMinutes()).padStart(2, '0');
      return `${year}-${month}-${day}T${hours}:${minutes}`;
    }


    function mostraAlerta(message, type) {
      const alertDiv = document.getElementById('alertaLogin');
      alertDiv.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show">
          ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      `;
      
      // Auto-remover após 5 segundos
      setTimeout(() => {
        const alert = alertDiv.querySelector('.alert');
        if (alert) {
          const bsAlert = new bootstrap.Alert(alert);
          bsAlert.close();
        }
      }, 5000);
    }
  });
</script>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-6TD0XJ72V0"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-6TD0XJ72V0');
  </script>
</body>

</html>
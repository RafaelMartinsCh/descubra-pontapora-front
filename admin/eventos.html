<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cadastro de Eventos</title>
  <link href="../src/icon.png" rel="icon" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
</head>

<body class="bg-light">
  <div id="header"></div>

  <!-- Alerta para mensagens de sucesso/erro -->
  <div id="alertaLogin" class="container mt-3"></div>

  <div class="container mt-4">
    <h2 class="mb-4">Cadastro de Eventos</h2>

    <!-- Formulário de Cadastro -->
    <div class="card mb-4">
      <div class="card-header" role="button" data-bs-toggle="collapse" data-bs-target="#collapseCadastro"
        aria-expanded="true" aria-controls="collapseCadastro">
        <h6 class="mb-0">Cadastrar Novo Evento</h6>
      </div>
      <div id="collapseCadastro" class="collapse show">
        <div class="card-body">
          <form id="formCadastro">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="titulo" class="form-label">Título</label>
                <input type="text" class="form-control" id="titulo" required>
              </div>
              <div class="col-md-6">
                <label for="local" class="form-label">Local</label>
                <input type="text" class="form-control" id="local" required>
              </div>
              <div class="col-md-4">
                <label for="data" class="form-label">Data</label>
                <input type="datetime-local" class="form-control" id="data" required>
              </div>
              <div class="col-md-4">
                <label for="dt_fim" class="form-label">Data Fim (opcional)</label>
                <input type="datetime-local" class="form-control" id="dt_fim">
              </div>
              <div class="col-md-4">
                <label for="descricao" class="form-label">Descrição</label>
                <input type="text" class="form-control" id="descricao" required>
              </div>
              <div class="col-md-6">
                <label for="imagem" class="form-label">URL Imagem Capa</label>
                <input type="url" class="form-control" id="imagem">
              </div>
              <div class="col-md-6">
                <label for="legenda_imagem" class="form-label">Legenda da Imagem</label>
                <input type="text" class="form-control" id="legenda_imagem">
              </div>
              <div class="col-12">
                <button type="submit" class="btn btn-primary w-100">Cadastrar</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Tabela de Eventos -->
    <div class="card">
      <div class="card-header fw-semibold">Eventos Cadastrados</div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered table-hover">
            <thead class="table-dark text-center">
              <tr>
                <th>Título</th>
                <th>Local</th>
                <th>Data</th>
                <th>Descrição</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="tabelaEventos"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Editar Evento -->
  <div class="modal fade" id="modalEditarEvento" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Editar Evento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editId">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="editTitulo" class="form-label">Título</label>
              <input type="text" class="form-control" id="editTitulo" required>
            </div>
            <div class="col-md-6">
              <label for="editLocal" class="form-label">Local</label>
              <input type="text" class="form-control" id="editLocal" required>
            </div>
            <div class="col-md-4">
              <label for="editData" class="form-label">Data</label>
              <input type="datetime-local" class="form-control" id="editData" required>
            </div>
            <div class="col-md-4">
              <label for="editDtFim" class="form-label">Data Fim (opcional)</label>
              <input type="datetime-local" class="form-control" id="editDtFim">
            </div>

            <!-- Campo de descrição modificado para textarea -->
            <div class="col-md-6">
              <label for="editImagem" class="form-label">URL Imagem Capa</label>
              <input type="url" class="form-control" id="editImagem">
            </div>
            <div class="col-md-6">
              <label for="editLegendaImagem" class="form-label">Legenda da Imagem</label>
              <input type="text" class="form-control" id="editLegendaImagem">
            </div>

            <div class="col-12">
              <label for="editDescricao" class="form-label">Descrição</label>
              <textarea class="form-control" id="editDescricao" rows="3" required></textarea>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="atualizarEvento()">Salvar Alterações</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="../js/header_adm.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../js/config.js"></script>
  <script src="../js/utils.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
    // DOM Elements
    const elements = {
        formCadastro: document.getElementById('formCadastro'),
        tabelaEventos: document.getElementById('tabelaEventos'),
        modalEditar: document.getElementById('modalEditarEvento'),
        btnSalvarEdicao: document.querySelector('#modalEditarEvento .btn-primary')
    };

    // Event Listeners
    elements.formCadastro.addEventListener('submit', enviar);
    elements.tabelaEventos.addEventListener('click', handleTableActions);
    elements.modalEditar.addEventListener('show.bs.modal', handleModalShow);
    elements.btnSalvarEdicao.addEventListener('click', atualizarEvento);

    // Initialize
    carregarEventos();

    // ========================
    //  Core Functions
    // ========================
    async function carregarEventos() {
      /**
       * Carrega dados dos eventos da API e renderiza na interface.
       * @async
       * @function {carregarEventos}
      */
        try {
            const response = await fetch(`${API_BASE_URL}/eventos/`);
            const eventos = await response.json();
            renderizarEventos(eventos);
        } catch (error) {
            mostraAlerta('Erro ao carregar eventos', 'danger');
        }
    }

    function renderizarEventos(eventos) {
    /**
     * Renderiza uma lista de eventos na tabela HTML.
     * 
     * Cada evento é exibido em uma linha contendo título, local, data,
     * descrição e botões de ação (editar/excluir).
     * 
     * @param {Array<Object>} eventos - Lista de objetos de eventos.
     * @param {number} eventos[].id - ID do evento.
     * @param {string} eventos[].titulo - Título do evento.
     * @param {string} eventos[].local - Local onde o evento ocorrerá.
     * @param {string|Date} eventos[].data - Data do evento (em formato ISO ou Date).
     * @param {string} eventos[].descricao - Descrição do evento.
     */
        elements.tabelaEventos.innerHTML = eventos.map(evento => `
            <tr data-id="${evento.id}">
                <td>${evento.titulo}</td>
                <td>${evento.local}</td>
                <td>${new Date(evento.data).toLocaleString()}</td>
                <td>${evento.descricao}</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-warning btn-editar me-2"
                        data-bs-toggle="modal"
                        data-bs-target="#modalEditarEvento"
                        data-event='${JSON.stringify(evento)}'>
                        Alterar
                    </button>
                    <button class="btn btn-sm btn-danger btn-excluir">Excluir</button>
                </td>
            </tr>
        `).join('');
    }

    // ========================
    //  Event Handlers
    // ========================
    async function enviar(e) {
      /**
       * Envia os dados do formulário de cadastro de evento para a API.
       * 
       * Intercepta o envio do formulário, envia os dados via POST,
       * e exibe mensagens de sucesso ou erro. Após o cadastro,
       * limpa o formulário e recarrega a lista de eventos.
       * 
       * @async
       * @param {Event} e - Evento de submissão do formulário.
       */
        e.preventDefault();
        const formData = carregarDadosFormulario(elements.formCadastro);

        try {
            const response = await fetch(`${API_BASE_URL}/eventos/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                elements.formCadastro.reset();
                mostraAlerta('Evento cadastrado com sucesso!', 'success');
                await carregarEventos();
            } else {
                mostraAlerta('Erro ao cadastrar evento', 'danger');
            }
        } catch (error) {
            mostraAlerta('Erro na comunicação com o servidor', 'danger');
        }
    }

    function handleTableActions(e) {
    /**
     * Manipula ações da tabela de eventos, como exclusão de um evento.
     *
     * Detecta cliques nos botões dentro da tabela e executa a ação
     * correspondente (ex: excluir evento).
     * 
     * @param {MouseEvent} e - Evento de clique na tabela.
     */
        const target = e.target;
        const row = target.closest('tr');
        const eventId = row.dataset.id;

        if (target.classList.contains('btn-excluir')) {
            excluirEvento(eventId);
        }
    }

    function handleModalShow(e) {
    /**
     * Manipula o evento de exibição do modal de edição de evento.
     * 
     * Recupera os dados do evento a partir do botão que abriu o modal
     * e popula o formulário com esses dados.
     * 
     * @param {Event} e - Evento de exibição do modal (geralmente 'show.bs.modal').
     */
        const button = e.relatedTarget;
        const eventData = JSON.parse(button.dataset.event);
        popularFormulario(eventData);
    }

    // ========================
    //  CRUD Operations
    // ========================
    async function atualizarEvento() {
    /**
     * Atualiza os dados de um evento existente.
     * 
     * Coleta os dados editados do formulário, envia uma requisição PUT
     * para a API e, se for bem-sucedida, fecha o modal de edição,
     * exibe uma mensagem de sucesso e recarrega a lista de eventos.
     * 
     * @async
     * @function atualizarEvento
     */
        const eventId = document.getElementById('editId').value;
        const formData = carregarDadosEditadosDoFormulario();

        try {
            const response = await fetch(`${API_BASE_URL}/eventos/${eventId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                bootstrap.Modal.getInstance(elements.modalEditar).hide();
                mostraAlerta('Evento atualizado com sucesso!', 'success');
                await carregarEventos();
            } else {
                mostraAlerta('Erro ao atualizar evento', 'danger');
            }
        } catch (error) {
            mostraAlerta('Erro na comunicação com o servidor', 'danger');
        }
    }

    async function excluirEvento(eventId) {
    /**
     * Exclui um evento após confirmação do usuário.
     * 
     * Envia uma requisição DELETE para a API e, em caso de sucesso,
     * exibe uma mensagem e recarrega a lista de eventos.
     * 
     * @async
     * @param {string|number} eventId - ID do evento a ser excluído.
     */
        if (!confirm('Deseja realmente excluir este evento?')) return;

        try {
            const response = await fetch(`${API_BASE_URL}/eventos/${eventId}`, {
                method: 'DELETE'
            });

            if (response.status === 204) {
                mostraAlerta('Evento excluído com sucesso!', 'success');
                await carregarEventos();
            } else {
                mostraAlerta('Erro ao excluir evento', 'danger');
            }
        } catch (error) {
            mostraAlerta('Erro na comunicação com o servidor', 'danger');
        }
    }

    // ========================
    //  Helper Functions
    // ========================
    function carregarDadosFormulario(form) {
    /**
     * Extrai os dados do formulário de cadastro de evento.
     * 
     * Retorna um objeto contendo os valores dos campos relevantes.
     * Campos opcionais retornam `null` se vazios.
     * 
     * @param {HTMLFormElement} form - Elemento do formulário HTML.
     * @returns {Object} Dados do formulário do evento.
     * @returns {string} retorno.titulo - Título do evento.
     * @returns {string} retorno.local - Local do evento.
     * @returns {string} retorno.data - Data inicial do evento.
     * @returns {string|null} retorno.dt_fim - Data final do evento (opcional).
     * @returns {string} retorno.descricao - Descrição do evento.
     * @returns {string|null} retorno.caminho_imagem_capa - Caminho da imagem de capa (opcional).
     * @returns {string|null} retorno.legenda_imagem_capa - Legenda da imagem de capa (opcional).
     */
        return {
            titulo: form.querySelector('#titulo').value,
            local: form.querySelector('#local').value,
            data: form.querySelector('#data').value,
            dt_fim: form.querySelector('#dt_fim').value || null,
            descricao: form.querySelector('#descricao').value,
            caminho_imagem_capa: form.querySelector('#imagem').value || null,
            legenda_imagem_capa: form.querySelector('#legenda_imagem').value || null
        };
    }

    function carregarDadosEditadosDoFormulario() {
    /**
     * Extrai os dados editados do formulário de edição de evento.
     * 
     * Retorna um objeto com os valores atualizados dos campos do formulário.
     * Campos opcionais retornam `null` se estiverem vazios.
     * 
     * @returns {Object} Dados editados do evento.
     * @returns {string} retorno.titulo - Título editado do evento.
     * @returns {string} retorno.local - Local editado do evento.
     * @returns {string} retorno.data - Data inicial editada do evento.
     * @returns {string|null} retorno.dt_fim - Data final editada do evento (opcional).
     * @returns {string} retorno.descricao - Descrição editada do evento.
     * @returns {string|null} retorno.caminho_imagem_capa - Caminho da imagem de capa editada (opcional).
     * @returns {string|null} retorno.legenda_imagem_capa - Legenda da imagem de capa editada (opcional).
     */
        return {
            titulo: document.getElementById('editTitulo').value,
            local: document.getElementById('editLocal').value,
            data: document.getElementById('editData').value,
            dt_fim: document.getElementById('editDtFim').value || null,
            descricao: document.getElementById('editDescricao').value,
            caminho_imagem_capa: document.getElementById('editImagem').value || null,
            legenda_imagem_capa: document.getElementById('editLegendaImagem').value || null
        };
    }

    function popularFormulario(eventData) {
    /**
     * Preenche o formulário de edição com os dados de um evento.
     * 
     * Formata as datas usando `formatarHoraLocal` e insere valores
     * nos campos correspondentes. Campos opcionais recebem string vazia
     * se estiverem ausentes.
     * 
     * @param {Object} eventData - Dados do evento a serem exibidos no formulário.
     * @param {string|number} eventData.id - ID do evento.
     * @param {string} eventData.titulo - Título do evento.
     * @param {string} eventData.local - Local do evento.
     * @param {string|Date|null} eventData.data - Data inicial do evento.
     * @param {string|Date|null} eventData.dt_fim - Data final do evento (opcional).
     * @param {string} eventData.descricao - Descrição do evento.
     * @param {string|null} eventData.caminho_imagem_capa - Caminho da imagem de capa (opcional).
     * @param {string|null} eventData.legenda_imagem_capa - Legenda da imagem da capa (opcional).
     */
        document.getElementById('editId').value = eventData.id;
        document.getElementById('editTitulo').value = eventData.titulo;
        document.getElementById('editLocal').value = eventData.local;
        document.getElementById('editData').value = formatarHoraLocal(eventData.data);
        document.getElementById('editDtFim').value = formatarHoraLocal(eventData.dt_fim);
        document.getElementById('editDescricao').value = eventData.descricao;
        document.getElementById('editImagem').value = eventData.caminho_imagem_capa || '';
        document.getElementById('editLegendaImagem').value = eventData.legenda_imagem_capa || '';
    }

    function formatarHoraLocal(dateString) {
    /**
     * Formata uma string de data para o formato ISO local (YYYY-MM-DDTHH:mm).
     * 
     * Essa formatação é útil para preencher inputs do tipo datetime-local.
     * Retorna uma string vazia se a data for inválida ou ausente.
     * 
     * @param {string|Date|null} dateString - Data em formato string ou objeto Date.
     * @returns {string} Data formatada no padrão YYYY-MM-DDTHH:mm ou string vazia.
     */
        if (!dateString) return '';
        const date = new Date(dateString);
        return date.toISOString().slice(0, 16);
    }

    function mostraAlerta(message, type) {
    /**
     * Exibe uma mensagem de alerta no elemento com ID 'alertaLogin'.
     * 
     * O alerta é estilizado conforme o tipo e inclui botão para fechar.
     * 
     * @param {string} message - Texto da mensagem a ser exibida.
     * @param {string} type - Tipo do alerta (ex: 'success', 'danger', 'warning', etc.).
     */
        const alertDiv = document.getElementById('alertaLogin');
        alertDiv.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    }
});
  </script>
</body>

</html>
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Descubra Ponta Porã - Eventos</title>
  <link rel="icon" href="/src/icon.png" type="image/x-icon" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" />
  <style>
    .card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      border: none;
      border-radius: 15px;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .card-img-top {
      border-top-left-radius: 15px;
      border-top-right-radius: 15px;
      width: 100%;
      height: 200px;
      object-fit: cover;
    }
  </style>
</head>

<body>

  <div id="header"></div>

  <div id="eventos"> 
    <section class="container my-5">
      <h2 class="mb-4">Próximos Eventos</h2>
      <div id="eventos-container" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4"></div>
      <div id="mensagem-vazio" class="alert alert-info mt-4" style="display: none;">
        Nenhum evento encontrado no momento.
      </div>
    </section>
  </div>

  <div id="footer"></div>

  <!-- Modal de Detalhes do Evento -->
  <div class="modal fade" id="modalEvento" tabindex="-1" aria-labelledby="modalEventoLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitulo">Detalhes do Evento</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <!-- ✅ Imagem centralizada -->
          <img id="modalImagem" src="" class="img-fluid rounded mb-3 d-block mx-auto" alt="Imagem do Evento" style="max-height: 300px; object-fit: cover;">
          <p id="modalDescricao" class="mb-3"></p>
          <p><strong>Local:</strong> <span id="modalLocal"></span></p>
          <p><strong>Data:</strong> <span id="modalData"></span></p>
          <p><strong>Status:</strong> <span id="modalStatus"></span></p>
          <p><strong>Site:</strong> <span id="modalSite"></span></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    async function carregaEventos() {
      try {
        const resposta = await fetch('http://127.0.0.1:5000/eventos/');
        if (!resposta.ok) {
          throw new Error(`Erro HTTP! status: ${resposta.status}`);
        }
        const eventos = await resposta.json();

        const container = document.getElementById('eventos-container');
        const mensagemVazio = document.getElementById('mensagem-vazio');
        container.innerHTML = "";

        if (eventos.length === 0) {
          mensagemVazio.style.display = 'block';
        } else {
          mensagemVazio.style.display = 'none';

          eventos.forEach(evento => {
            const dataEvento = new Date(evento.data);
            const dataFimEvento = evento.dt_fim ? new Date(evento.dt_fim) : null;

            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const dataFormatada = dataEvento.toLocaleDateString('pt-BR', options);
            const dataFimFormatada = dataFimEvento ? dataFimEvento.toLocaleDateString('pt-BR', options) : '';

            const statusBadge = evento.aberto
              ? '<span class="badge bg-success">Aberto</span>'
              : '<span class="badge bg-danger">Encerrado</span>';

            const imagem = evento.caminho_imagem_capa || 'https://placehold.co/600x400/eeeeee/cccccc?text=Sem+Imagem';

            const cardHTML = `
              <div class="col">
                <div class="card h-100 shadow-sm card-evento" 
                  style="cursor:pointer; border-radius: 15px;" 
                  data-evento='${JSON.stringify(evento).replace(/'/g, "&apos;")}'>
                  <img src="${imagem}" class="card-img-top" alt="Imagem do evento ${evento.titulo}" 
                       onerror="this.onerror=null;this.src='https://placehold.co/600x400/eeeeee/cccccc?text=Imagem+Inv%C3%A1lida';">
                  <div class="card-body d-flex flex-column">
                    <h5 class="card-title">${evento.titulo}</h5>
                    <p class="text-muted mb-2">${dataFormatada}${dataFimFormatada ? ` - ${dataFimFormatada}` : ''}</p>
                    <p class="card-text">${evento.descricao?.substring(0, 100) || 'Sem descrição.'}...</p>
                    <div class="mt-auto">
                      ${statusBadge}
                    </div>
                  </div>
                </div>
              </div>
            `;
            container.innerHTML += cardHTML;
          });

          // Adiciona evento para abrir modal ao clicar no card
          document.querySelectorAll('.card-evento').forEach(card => {
            card.addEventListener('click', () => {
              const evento = JSON.parse(card.dataset.evento.replace(/&apos;/g, "'"));
              preencherModal(evento);
              const modal = new bootstrap.Modal(document.getElementById('modalEvento'));
              modal.show();
            });
          });
        }
      } catch (error) {
        console.error("Erro ao carregar eventos:", error);
        const container = document.getElementById('eventos-container');
        container.innerHTML = `<div class="col"><div class="alert alert-danger" role="alert">Não foi possível carregar os eventos. Verifique sua conexão ou tente novamente mais tarde.</div></div>`;
      }
    }

    function preencherModal(evento) {
      document.getElementById('modalTitulo').textContent = evento.titulo;
      document.getElementById('modalImagem').src = evento.caminho_imagem_capa || 'https://placehold.co/600x400/eeeeee/cccccc?text=Sem+Imagem';
      document.getElementById('modalDescricao').textContent = evento.descricao || 'Sem descrição.';
      document.getElementById('modalLocal').textContent = evento.local || 'Local não informado';
      document.getElementById('modalData').textContent = new Date(evento.data).toLocaleDateString('pt-BR');
      document.getElementById('modalStatus').innerHTML = evento.aberto
        ? '<span class="badge bg-success">Aberto</span>'
        : '<span class="badge bg-danger">Encerrado</span>';
      document.getElementById('modalSite').innerHTML = evento.site
        ? `<a href="${evento.site}" target="_blank">${evento.site}</a>`
        : 'Site não informado';
    }

    document.addEventListener('DOMContentLoaded', carregaEventos);
  </script>

  <script src="../js/layout.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
